# ---------------------------------------------------------------
# Issue Intake Workflow
# Triggers on every new, edited, or reopened issue.
# Runs a Python script that triages the issue via Devin and
# optionally queues an auto-fix PR.
# ---------------------------------------------------------------
name: Issue Intake â€“ Triage & Auto-Fix

on:
  issues:
    types: [opened, edited, reopened]

# Only allow ONE run at a time per issue number so we never
# double-label or double-comment on the same issue.
concurrency:
  group: issue-intake-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  issues: write        # post comments, add labels
  contents: write      
  pull-requests: write # create PRs

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repo so our scripts are available.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # 3. Install dependencies.
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Run the intake script.
      #    All config comes from environment variables / secrets.
      - name: Run issue intake
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEVIN_SERVICE_TOKEN: ${{ secrets.DEVIN_SERVICE_TOKEN }}
          DEVIN_API_BASE_URL: ${{ secrets.DEVIN_API_BASE_URL }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_FIX_ENABLED: ${{ secrets.DEVIN_FIX_ENABLED || 'true' }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: python -m scripts.intake
