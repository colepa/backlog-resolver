# ---------------------------------------------------------------
# Issue Intake Workflow
# Receives a repository_dispatch event from a target repo and
# triages the issue via Devin, optionally queuing an auto-fix PR.
#
# Setup:
#   1. Add a GH_PAT secret (PAT with `repo` scope for the target repo).
#   2. Install the dispatch workflow in your target repo
#      (see .github/workflows/target-repo-dispatch.yml).
# ---------------------------------------------------------------
name: Issue Intake â€“ Triage & Auto-Fix

on:
  repository_dispatch:
    types: [issue-intake]

# Only allow ONE run at a time per issue number so we never
# double-label or double-comment on the same issue.
concurrency:
  group: issue-intake-${{ github.event.client_payload.repo }}-${{ github.event.client_payload.issue_number }}
  cancel-in-progress: true

permissions:
  contents: read       # checkout this repo's scripts

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repo so our scripts are available.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # 3. Install dependencies.
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Run the intake script.
      #    GITHUB_TOKEN is a PAT so the script can read/write
      #    issues, labels, and PRs on the *target* repo.
      - name: Run issue intake
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          DEVIN_SERVICE_TOKEN: ${{ secrets.DEVIN_SERVICE_TOKEN }}
          DEVIN_API_BASE_URL: ${{ secrets.DEVIN_API_BASE_URL }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_FIX_ENABLED: ${{ secrets.DEVIN_FIX_ENABLED || 'true' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          REPO_FULL_NAME: ${{ github.event.client_payload.repo }}
          TRIGGER_ACTION: ${{ github.event.client_payload.action || '' }}
          TRIGGER_LABEL: ${{ github.event.client_payload.label || '' }}
        run: python -m scripts.intake
